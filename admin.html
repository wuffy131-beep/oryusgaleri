<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Paneli - Oryus Galeri</title>
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <header>
      <h1>ğŸ› ï¸ Admin Paneli</h1>
      <nav id="adminMenu" class="hidden">
        <a href="#" onclick="showSection('ilanlar')">ğŸ“¦ Ä°lanlar</a>
        <a href="#" onclick="showSection('logs')">ğŸ§¾ Loglar</a>
        <a href="#" onclick="showSection('settings')">âš™ï¸ Site YÃ¶netimi</a>
        <a href="#" onclick="logout()">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
      </nav>
    </header>

    <!-- GiriÅŸ Formu -->
    <main id="loginForm">
      <h2>ğŸ” GiriÅŸ Yap</h2>
      <input type="text" id="username" placeholder="KullanÄ±cÄ± AdÄ±" /><br />
      <input type="password" id="password" placeholder="Åifre" /><br />
      <button onclick="login()">GiriÅŸ Yap</button>
      <p id="loginError" style="color:red"></p>
    </main>

    <!-- Ä°lan YÃ¶netimi -->
    <section id="ilanlar" class="hidden">
      <h2>ğŸ“‹ Ä°lan YÃ¶netimi</h2>
      <button onclick="showAddIlan()">Yeni Ä°lan Ekle</button>
      <div id="ilanList"></div>
    </section>

    <!-- Loglar -->
    <section id="logs" class="hidden">
      <h2>ğŸ§¾ Loglar</h2>
      <div id="logList">YÃ¼kleniyor...</div>
    </section>

    <!-- Site YÃ¶netimi -->
    <section id="settings" class="hidden">
      <h2>âš™ï¸ Site YÃ¶netimi</h2>
      <button onclick="toggleSite()">ğŸ•¹ï¸ Siteyi AÃ§ / Kapat</button>
      <p id="statusMsg"></p>
    </section>

    <script>
      const API_BASE = "https://oryusgaleri.vercel.app/api";
      let token = localStorage.getItem("adminToken");

      document.addEventListener("DOMContentLoaded", () => {
        if (token) {
          document.getElementById("loginForm").classList.add("hidden");
          document.getElementById("adminMenu").classList.remove("hidden");
          showSection("ilanlar");
          fetchIlanlar();
        }
      });

      async function login() {
        const u = document.getElementById("username").value.trim();
        const p = document.getElementById("password").value.trim();
        const err = document.getElementById("loginError");
        err.textContent = "";

        try {
          const res = await fetch(`${API_BASE}/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: u, password: p }),
          });
          const data = await res.json();

          if (!res.ok) throw new Error(data.error || "GiriÅŸ baÅŸarÄ±sÄ±z");

          localStorage.setItem("adminToken", data.token);
          token = data.token;

          document.getElementById("loginForm").classList.add("hidden");
          document.getElementById("adminMenu").classList.remove("hidden");
          showSection("ilanlar");
          fetchIlanlar();
        } catch (e) {
          err.textContent = "âŒ " + e.message;
        }
      }

      function logout() {
        localStorage.removeItem("adminToken");
        location.reload();
      }

      function showSection(id) {
        ["ilanlar", "logs", "settings"].forEach((s) =>
          document.getElementById(s).classList.add("hidden")
        );
        document.getElementById(id).classList.remove("hidden");

        if (id === "logs") fetchLogs();
      }

      async function fetchIlanlar() {
        const list = document.getElementById("ilanList");
        list.innerHTML = "YÃ¼kleniyor...";
        const res = await fetch(`${API_BASE}/ilanlar`);
        const data = await res.json();

        list.innerHTML = data
          .map(
            (i) => `
          <div class="ilan">
            <h3>${i.baslik}</h3>
            <img src="${i.resim}" style="max-width:200px" />
            <p>${i.aciklama}</p>
            <p><b>Fiyat:</b> ${i.fiyat || "-"} TL</p>
            <button onclick="deleteIlan(${i.id})">Sil</button>
          </div>`
          )
          .join("");
      }

      async function fetchLogs() {
        const list = document.getElementById("logList");
        list.innerHTML = "YÃ¼kleniyor...";
        const res = await fetch(`${API_BASE}/logs`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const data = await res.json();
        list.innerHTML = data
          .map(
            (l) =>
              `<p>[${l.created_at}] <b>${l.admin}</b> â†’ ${l.action} (${l.detail})</p>`
          )
          .join("");
      }

      async function deleteIlan(id) {
        if (!confirm("Bu ilan silinsin mi?")) return;
        await fetch(`${API_BASE}/deleteIlan?id=${id}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${token}` },
        });
        fetchIlanlar();
      }

      async function toggleSite() {
        const msg = document.getElementById("statusMsg");
        try {
          const res = await fetch(`${API_BASE}/status`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });
          const data = await res.json();
          msg.textContent = data.message;
        } catch {
          msg.textContent = "âŒ Sunucu hatasÄ±.";
        }
      }
    </script>
  </body>
</html>
