<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Paneli - Oryus Galeri</title>
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <header>
      <h1>🛠️ Admin Paneli</h1>
      <nav id="adminMenu" class="hidden">
        <a href="#" onclick="showSection('ilanlar')">📦 İlanlar</a>
        <a href="#" onclick="showSection('logs')">🧾 Loglar</a>
        <a href="#" onclick="showSection('settings')">⚙️ Site Yönetimi</a>
        <a href="#" onclick="logout()">🚪 Çıkış Yap</a>
      </nav>
    </header>

    <!-- Giriş Formu -->
    <main id="loginForm">
      <h2>🔐 Giriş Yap</h2>
      <input type="text" id="username" placeholder="Kullanıcı Adı" /><br />
      <input type="password" id="password" placeholder="Şifre" /><br />
      <button onclick="login()">Giriş Yap</button>
      <p id="loginError" style="color:red"></p>
    </main>

    <!-- İlan Yönetimi -->
    <section id="ilanlar" class="hidden">
      <h2>📋 İlan Yönetimi</h2>
      <button onclick="showAddIlan()">Yeni İlan Ekle</button>
      <div id="ilanList"></div>
    </section>

    <!-- Loglar -->
    <section id="logs" class="hidden">
      <h2>🧾 Loglar</h2>
      <div id="logList">Yükleniyor...</div>
    </section>

    <!-- Site Yönetimi -->
    <section id="settings" class="hidden">
      <h2>⚙️ Site Yönetimi</h2>
      <button onclick="toggleSite()">🕹️ Siteyi Aç / Kapat</button>
      <p id="statusMsg"></p>
    </section>

    <script>
      const API_BASE = "https://oryusgaleri.vercel.app/api";
      let token = localStorage.getItem("adminToken");

      document.addEventListener("DOMContentLoaded", () => {
        if (token) {
          document.getElementById("loginForm").classList.add("hidden");
          document.getElementById("adminMenu").classList.remove("hidden");
          showSection("ilanlar");
          fetchIlanlar();
        }
      });

      async function login() {
        const u = document.getElementById("username").value.trim();
        const p = document.getElementById("password").value.trim();
        const err = document.getElementById("loginError");
        err.textContent = "";

        try {
          const res = await fetch(`${API_BASE}/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: u, password: p }),
          });
          const data = await res.json();

          if (!res.ok) throw new Error(data.error || "Giriş başarısız");

          localStorage.setItem("adminToken", data.token);
          token = data.token;

          document.getElementById("loginForm").classList.add("hidden");
          document.getElementById("adminMenu").classList.remove("hidden");
          showSection("ilanlar");
          fetchIlanlar();
        } catch (e) {
          err.textContent = "❌ " + e.message;
        }
      }

      function logout() {
        localStorage.removeItem("adminToken");
        location.reload();
      }

      function showSection(id) {
        ["ilanlar", "logs", "settings"].forEach((s) =>
          document.getElementById(s).classList.add("hidden")
        );
        document.getElementById(id).classList.remove("hidden");

        if (id === "logs") fetchLogs();
      }

      async function fetchIlanlar() {
        const list = document.getElementById("ilanList");
        list.innerHTML = "Yükleniyor...";
        const res = await fetch(`${API_BASE}/ilanlar`);
        const data = await res.json();

        list.innerHTML = data
          .map(
            (i) => `
          <div class="ilan">
            <h3>${i.baslik}</h3>
            <img src="${i.resim}" style="max-width:200px" />
            <p>${i.aciklama}</p>
            <p><b>Fiyat:</b> ${i.fiyat || "-"} TL</p>
            <button onclick="deleteIlan(${i.id})">Sil</button>
          </div>`
          )
          .join("");
      }

      async function fetchLogs() {
        const list = document.getElementById("logList");
        list.innerHTML = "Yükleniyor...";
        const res = await fetch(`${API_BASE}/logs`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const data = await res.json();
        list.innerHTML = data
          .map(
            (l) =>
              `<p>[${l.created_at}] <b>${l.admin}</b> → ${l.action} (${l.detail})</p>`
          )
          .join("");
      }

      async function deleteIlan(id) {
        if (!confirm("Bu ilan silinsin mi?")) return;
        await fetch(`${API_BASE}/deleteIlan?id=${id}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${token}` },
        });
        fetchIlanlar();
      }

      async function toggleSite() {
        const msg = document.getElementById("statusMsg");
        try {
          const res = await fetch(`${API_BASE}/status`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });
          const data = await res.json();
          msg.textContent = data.message;
        } catch {
          msg.textContent = "❌ Sunucu hatası.";
        }
      }
    </script>
  </body>
</html>
